<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0d6efd">
<link rel="manifest" href="manifest.json">

<title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>

<style>
body{margin:0;font-family:system-ui;background:#f4f6f9}
header{background:#0d6efd;color:#fff;padding:14px;text-align:center}
#version{font-size:12px;opacity:.8}
main{padding:12px}

.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px}
input,select,button{width:100%;padding:10px;margin-top:6px;font-size:14px}
button{background:#0d6efd;color:#fff;border:none;border-radius:8px}

.record{display:flex;justify-content:space-between;font-size:14px;padding:8px 0;border-bottom:1px solid #eee}
.income{color:#0d6efd}
.expense{color:#dc3545}

.edit-btn{
  background:#ffc107;color:#000;
  border-radius:6px;padding:4px 6px;font-size:12px;
  margin-left:6px;
}

/* ===== EXIT POPUP ===== */
.exit-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.exit-box{
  background:#fff;
  border-radius:16px;
  padding:20px;
  width:80%;
  max-width:300px;
  text-align:center;
}
.exit-actions{display:flex;gap:10px;margin-top:10px}
.exit-actions button{flex:1}
.btn-cancel{background:#ccc;color:#000}
.btn-exit{background:#dc3545}
</style>
</head>

<body>

<header>
  üìä ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
  <div id="version">v2.0</div>
</header>

<main>
  <div class="card">
    <input type="date" id="date">
    <input type="text" id="title" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
    <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
    <select id="type">
      <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
      <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
    </select>
    <button onclick="addRecord()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  </div>

  <div class="card">
    <input type="text" id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="render()">
  </div>

  <div class="card" id="list"></div>
</main>

<!-- EDIT MODAL -->
<div class="exit-overlay" id="editModal">
  <div class="exit-box">
    <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
    <input type="date" id="editDate">
    <input type="text" id="editTitle">
    <input type="number" id="editAmount">

    <div class="exit-actions">
      <button onclick="saveEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn-exit" onclick="deleteEdit()">‡∏•‡∏ö</button>
      <button class="btn-cancel" onclick="closeEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<!-- EXIT CONFIRM -->
<div class="exit-overlay" id="exitPopup">
  <div class="exit-box">
    <h3>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ?</h3>
    <div class="exit-actions">
      <button class="btn-cancel" onclick="closeExit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-exit" onclick="exitApp()">‡∏≠‡∏≠‡∏Å</button>
    </div>
  </div>
</div>

<script>
const dateInput = document.getElementById("date");
const titleInput = document.getElementById("title");
const amountInput = document.getElementById("amount");
const typeInput = document.getElementById("type");
const list = document.getElementById("list");
const search = document.getElementById("search");

let records = JSON.parse(localStorage.getItem("records") || "[]");
let editIndex = null;

dateInput.value = new Date().toISOString().slice(0,10);

function render(){
  list.innerHTML = "";
  const q = search.value.toLowerCase();

  records.filter(r=>r.title.toLowerCase().includes(q))
    .forEach((r,i)=>{
      list.innerHTML += `
        <div class="record ${r.type}">
          <span>${r.date} ${r.title}</span>
          <span>
            ${r.amount}
            <button class="edit-btn" onclick="openEdit(${i})">‚úèÔ∏è</button>
          </span>
        </div>`;
    });
}

function addRecord(){
  if(!titleInput.value || !amountInput.value) return;
  records.push({
    date: dateInput.value,
    title: titleInput.value,
    amount: +amountInput.value,
    type: typeInput.value
  });
  save();
}

function openEdit(i){
  editIndex = i;
  const r = records[i];
  editDate.value = r.date;
  editTitle.value = r.title;
  editAmount.value = r.amount;
  document.getElementById("editModal").style.display="flex";
}

function saveEdit(){
  records[editIndex] = {
    date: editDate.value,
    title: editTitle.value,
    amount: +editAmount.value,
    type: records[editIndex].type
  };
  closeEdit();
  save();
}

function deleteEdit(){
  if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")){
    records.splice(editIndex,1);
    closeEdit();
    save();
  }
}

function closeEdit(){
  document.getElementById("editModal").style.display="none";
}

function save(){
  localStorage.setItem("records", JSON.stringify(records));
  render();
}

// EXIT HANDLER
history.pushState(null,"",location.href);
window.addEventListener("popstate",()=>{
  document.getElementById("exitPopup").style.display="flex";
  history.pushState(null,"",location.href);
});
function closeExit(){document.getElementById("exitPopup").style.display="none";}
function exitApp(){history.back();}

// SERVICE WORKER
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}

render();
</script>

</body>
</html>
