<!DOCTYPE html>
<html lang="th">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f4f6f9}
header{background:#0d6efd;color:#fff;padding:14px;text-align:center}
#version{font-size:12px;opacity:.8}
main{padding:12px}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px}
input,select,button{width:100%;padding:10px;margin-top:6px;font-size:14px}
button{background:#0d6efd;color:#fff;border:none;border-radius:8px}
.record{display:flex;justify-content:space-between;font-size:14px;padding:8px 0;border-bottom:1px solid #eee;cursor:pointer}
.income{color:#0d6efd}
.expense{color:#dc3545}
.highlight{background:yellow}

/* ===== PIN ===== */
#pinLock{
  position:fixed;inset:0;background:#111;color:#fff;
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  z-index:999
}
.pin-dots{font-size:32px;letter-spacing:10px}
.keypad{display:grid;grid-template-columns:repeat(3,80px);gap:10px;margin-top:20px}
.keypad button{height:60px;font-size:20px;border-radius:10px}

/* ===== EDIT MODAL ===== */
#editModal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal-box{
  background:#fff;
  width:90%;
  max-width:360px;
  border-radius:16px;
  padding:16px;
  animation:pop .2s ease;
}
@keyframes pop{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}
.type-switch{display:flex;gap:8px;margin-top:10px}
.type-switch button{flex:1;background:#eee;color:#000}
.type-switch .active{background:#0d6efd;color:#fff}
.modal-actions{display:flex;gap:8px;margin-top:12px}
.modal-actions button{flex:1}
.danger{background:#dc3545}
.ghost{background:#6c757d}
</style>
</head>

<body>

<header>
üìä ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
<div id="version">Version 1.5.0</div>
</header>

<main>

<div class="card">
  <input type="date" id="date">
  <input type="text" id="title" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
  <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
  <select id="type">
    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
  </select>
  <button onclick="addRecord()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>

<div class="card">
  <input type="text" id="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="render()">
</div>

<div class="card" id="list"></div>

<div class="card">
  <button onclick="showSummary()">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  <button onclick="backup()">üì§ Backup</button>
  <button onclick="restore()">üì• Restore</button>
  <button onclick="exportExcel()">üìä Export Excel</button>
</div>

</main>

<!-- ===== EDIT POPUP ===== -->
<div id="editModal">
  <div class="modal-box">
    <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
    <input type="date" id="editDate">
    <input type="text" id="editTitle">
    <input type="number" id="editAmount">

    <div class="type-switch">
      <button id="btnIncome" onclick="setEditType('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
      <button id="btnExpense" onclick="setEditType('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    </div>

    <div class="modal-actions">
      <button onclick="saveEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="danger" onclick="deleteEdit()">‡∏•‡∏ö</button>
      <button class="ghost" onclick="closeEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== PIN LOCK ===== -->
<div id="pinLock">
  <div id="pinTitle">‡∏ï‡∏±‡πâ‡∏á PIN 4 ‡∏´‡∏•‡∏±‡∏Å</div>
  <div class="pin-dots" id="dots">____</div>
  <div class="keypad"></div>
</div>

<script>
const records = JSON.parse(localStorage.getItem("records")||"[]");
const PIN_KEY="pinCode";

/* ===== ADD ===== */
function addRecord(){
  records.push({
    date:date.value,
    title:title.value,
    amount:+amount.value,
    type:type.value
  });
  localStorage.setItem("records",JSON.stringify(records));
  render();
}

/* ===== RENDER ===== */
function render(){
  const q=search.value.toLowerCase();
  list.innerHTML="";
  records
    .sort((a,b)=>a.date.localeCompare(b.date))
    .filter(r=>r.title.toLowerCase().includes(q))
    .forEach((r,i)=>{
      list.innerHTML+=`
      <div class="record ${r.type}" onclick="openEdit(${i})">
        <span>${r.date} ${r.title}</span>
        <span>${r.amount}</span>
      </div>`;
    });
}

/* ===== EDIT ===== */
let editIndex=null, editType="income";
function openEdit(i){
  editIndex=i;
  const r=records[i];
  editDate.value=r.date;
  editTitle.value=r.title;
  editAmount.value=r.amount;
  setEditType(r.type);
  editModal.style.display="flex";
}
function closeEdit(){editModal.style.display="none"}
function setEditType(t){
  editType=t;
  btnIncome.classList.toggle("active",t==="income");
  btnExpense.classList.toggle("active",t==="expense");
}
function saveEdit(){
  records[editIndex]={
    date:editDate.value,
    title:editTitle.value,
    amount:+editAmount.value,
    type:editType
  };
  localStorage.setItem("records",JSON.stringify(records));
  closeEdit();render();
}
function deleteEdit(){
  if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?"))return;
  records.splice(editIndex,1);
  localStorage.setItem("records",JSON.stringify(records));
  closeEdit();render();
}

/* ===== SUMMARY / BACKUP / EXPORT ===== */
function showSummary(){
  let i=0,e=0;
  records.forEach(r=>r.type==="income"?i+=r.amount:e+=r.amount);
  alert(`‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ${i}\n‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ${e}\n‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${i-e}`);
}
function backup(){
  download(new Blob([JSON.stringify(localStorage)],{type:"application/json"}),"backup.json");
}
function restore(){
  const i=document.createElement("input");i.type="file";
  i.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{
      const d=JSON.parse(r.result);
      for(let k in d)localStorage.setItem(k,d[k]);
      location.reload();
    };
    r.readAsText(e.target.files[0]);
  };
  i.click();
}
function exportExcel(){
  let html="<table><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th></tr>";
  records.forEach(r=>html+=`<tr><td>${r.date}</td><td>${r.title}</td><td>${r.amount}</td><td>${r.type}</td></tr>`);
  download(new Blob(['\ufeff'+html],{type:"application/vnd.ms-excel"}),"records.xls");
}
function download(b,n){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);a.download=n;a.click();
}

/* ===== PIN ===== */
const pinLock=document.getElementById("pinLock");
const dots=document.getElementById("dots");
const pinTitle=document.getElementById("pinTitle");
let pin="",savedPIN=localStorage.getItem(PIN_KEY);
let mode=savedPIN?"unlock":"setup";
pinTitle.textContent=mode==="setup"?"‡∏ï‡∏±‡πâ‡∏á PIN 4 ‡∏´‡∏•‡∏±‡∏Å":"‡πÉ‡∏™‡πà PIN";
const pad=document.querySelector(".keypad");
for(let i=1;i<=9;i++)btn(i);btn(0);
function btn(n){
  const b=document.createElement("button");
  b.textContent=n;b.onclick=()=>press(n);pad.appendChild(b);
}
function press(n){
  pin+=n;dots.textContent=pin.padEnd(4,"_");
  if(pin.length===4){
    if(mode==="setup"){localStorage.setItem(PIN_KEY,pin);}
    else if(pin!==savedPIN){alert("PIN ‡∏ú‡∏¥‡∏î");pin="";dots.textContent="____";return;}
    pinLock.style.display="none";pin="";dots.textContent="____";
  }
}

render();
if("serviceWorker"in navigator)navigator.serviceWorker.register("./sw.js");
</script>
</body>
</html>
